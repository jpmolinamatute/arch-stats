name: Backend Type Check, Linting & Formatting

on:
  pull_request:
    paths:
      - backend/**/*.py
      - backend/pyproject.toml
      - .github/workflows/backend_linting.yaml

permissions:
  contents: read

defaults:
  run:
    shell: bash
    working-directory: backend

jobs:
  linting:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set uv & Install Dependencies
        uses: ./.github/actions/uv-setup
      - name: Run ruff check
        run: |
          source ./.venv/bin/activate
          ruff check --no-cache --config ./pyproject.toml ./src ./tests

  formatting:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set uv & Install Dependencies
        uses: ./.github/actions/uv-setup
      - name: Run ruff format
        run: |
          source ./.venv/bin/activate
          ruff format --check --no-cache --config ./pyproject.toml ./src ./tests

  mypy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set uv & Install Dependencies
        uses: ./.github/actions/uv-setup
      - name: Run mypy
        run: |
          source ./.venv/bin/activate
          mypy --config-file ./pyproject.toml ./src ./tests

  tests:
    runs-on: ubuntu-latest
    needs:
      - linting
      - formatting
      - mypy
    services:
      postgres:
        image: postgres:17.2
        env:
          POSTGRES_USER: "admin"
          POSTGRES_PASSWORD: "NOT_A_REAL_PASSWORD"
          POSTGRES_DB: "arch-stats"
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U admin"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set uv & Install Dependencies
        uses: ./.github/actions/uv-setup
      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
      - name: Wait for Postgres to be ready
        run: |
          for i in {1..30}; do
            if (echo > /dev/tcp/127.0.0.1/5432) >/dev/null 2>&1; then
              echo "Postgres is accepting TCP connections"
              break
            fi
            echo "Waiting for Postgres (attempt $i)..."
            sleep 2
          done
      - name: Validate migrations secrets
        env:
          MIGRATIONS_REPOSITORY: ${{ secrets.MIGRATIONS_REPOSITORY }}
          MIGRATIONS_PAT: ${{ secrets.MIGRATIONS_PAT }}
        run: |
          if [ -z "${MIGRATIONS_REPOSITORY}" ] || [ -z "${MIGRATIONS_PAT}" ]; then
            echo "Error: MIGRATIONS_REPOSITORY and/or MIGRATIONS_PAT secrets are not set." >&2
            echo "Set them in repo settings to enable Flyway migrations during CI." >&2
            exit 1
          fi
      - name: Checkout migrations repository
        # Requires two repo secrets configured in this repository:
        #  - MIGRATIONS_REPOSITORY: e.g. "<owner>/<private-migrations-repo>"
        #  - MIGRATIONS_PAT: a fine-scoped PAT with repo read access
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.MIGRATIONS_REPOSITORY }}
          token: ${{ secrets.MIGRATIONS_PAT }}
          path: backend/migrations
      - name: Run Flyway migrations
        env:
          FLYWAY_URL: "jdbc:postgresql://127.0.0.1:5432/arch-stats"
          FLYWAY_USER: "admin"
          FLYWAY_PASSWORD: "NOT_A_REAL_PASSWORD"
        run: |
          # Ensure migrations directory exists (checkout above should have created it)
          mkdir -p "${{ github.workspace }}/backend/migrations"
          # Run flyway in a container against the service Postgres on localhost
          docker run --rm \
            --network host \
            -e FLYWAY_URL="$FLYWAY_URL" \
            -e FLYWAY_USER="$FLYWAY_USER" \
            -e FLYWAY_PASSWORD="$FLYWAY_PASSWORD" \
            -e FLYWAY_LOCATIONS=filesystem:/flyway/sql \
            -v "${{ github.workspace }}/backend/migrations:/flyway/sql" \
            flyway/flyway:latest migrate
      - name: Run Tests
        env:
          POSTGRES_USER: "admin"
          POSTGRES_PASSWORD: "NOT_A_REAL_PASSWORD"
          POSTGRES_DB: "arch-stats"
          POSTGRES_HOST: "127.0.0.1"
          POSTGRES_PORT: "5432"
          ARCH_STATS_DEV_MODE: "true"
          ARCH_STATS_SERVER_PORT: "8000"
          ARCH_STATS_JWT_SECRET: "dev-insecure-change-me"
          ARCH_STATS_JWT_ALGORITHM: "HS256"
          ARCH_STATS_JWT_TTL_MINUTES: "60"
          ARCH_STATS_GOOGLE_OAUTH_CLIENT_ID: "NOT_A_REAL_CLIENT_ID"
          PYTHONPATH: "${{ github.workspace }}/backend/src"
        run: |
          source ./.venv/bin/activate
          pytest --maxfail=1 --disable-warnings -q
