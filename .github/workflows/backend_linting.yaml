name: Backend Type Check, Linting & Formatting

on:
  pull_request:
    paths:
      - backend/**/*.py
      - backend/pyproject.toml
      - .github/workflows/backend_linting.yaml

permissions:
  contents: read

defaults:
  run:
    shell: bash
    working-directory: ./backend

jobs:
  black:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set uv & Install Dependencies
        uses: ./.github/actions/uv-setup
      - name: Run black
        run: |
          source .venv/bin/activate
          black --check --config ./pyproject.toml ./src

  isort:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set uv & Install Dependencies
        uses: ./.github/actions/uv-setup
      - name: Run isort
        run: |
          source .venv/bin/activate
          isort --check-only --settings-file ./pyproject.toml ./src

  mypy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set uv & Install Dependencies
        uses: ./.github/actions/uv-setup
      - name: Run mypy
        run: |
          source .venv/bin/activate
          mypy --config-file ./pyproject.toml ./src

  pylint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set uv & Install Dependencies
        uses: ./.github/actions/uv-setup
      - name: Run pylint
        run: |
          source .venv/bin/activate
          pylint --rcfile ./pyproject.toml ./src

  tests:
    runs-on: ubuntu-latest
    needs:
      - black
      - isort
      - mypy
      - pylint
    services:
      postgres:
        image: postgres:17.2
        env:
          POSTGRES_USER: "admin"
          POSTGRES_PASSWORD: "NOT_A_REAL_PASSWORD"
        ports:
          - 5432:5432
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set uv & Install Dependencies
        uses: ./.github/actions/uv-setup
      - name: Run Tests
        env:
          POSTGRES_USER: "admin"
          POSTGRES_PASSWORD: "NOT_A_REAL_PASSWORD"
          POSTGRES_DB: "arch-stats"
          POSTGRES_HOST: "postgres"
          POSTGRES_PORT: "5432"
          ARCH_STATS_DEV_MODE: "true"
          ARCH_STATS_SERVER_PORT: "8000"
          ARCH_STATS_WS_CHANNEL: "archy"
        run: |
          source .venv/bin/activate
          pytest --maxfail=1 --disable-warnings -q
