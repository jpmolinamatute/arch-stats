name: Build Artifact
on:
  push:
    branches:
      - main

permissions:
  contents: write

defaults:
  run:
    shell: bash

jobs:
  build:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:17.2
        env:
          POSTGRES_USER: "admin"
          POSTGRES_PASSWORD: "NOT_A_REAL_PASSWORD"
          POSTGRES_DB: "arch-stats"
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U admin"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set uv & Install Dependencies
        uses: ./.github/actions/uv-setup
      - name: Setup Node & Install Dependencies
        uses: ./.github/actions/npm-setup
      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
      - name: Wait for Postgres to be ready
        run: |
          for i in {1..30}; do
            if (echo > /dev/tcp/127.0.0.1/5432) >/dev/null 2>&1; then
              echo "Postgres is accepting TCP connections"
              break
            fi
            echo "Waiting for Postgres (attempt $i)..."
            sleep 2
          done
      - name: Ensure required DB extensions exist
        env:
          PGPASSWORD: "NOT_A_REAL_PASSWORD"
        run: |
          psql \
            -h 127.0.0.1 \
            -p 5432 \
            -U admin \
            -d arch-stats \
            -v ON_ERROR_STOP=1 \
            -c 'CREATE EXTENSION IF NOT EXISTS "uuid-ossp";'
      - name: Validate migrations secrets
        env:
          MIGRATIONS_REPOSITORY: ${{ secrets.MIGRATIONS_REPOSITORY }}
          MIGRATIONS_PAT: ${{ secrets.MIGRATIONS_PAT }}
        run: |
          if [ -z "${MIGRATIONS_REPOSITORY}" ] || [ -z "${MIGRATIONS_PAT}" ]; then
            echo "Error: MIGRATIONS_REPOSITORY and/or MIGRATIONS_PAT secrets are not set." >&2
            echo "Set them in repo settings to enable Flyway migrations during CI." >&2
            exit 1
          fi
      - name: Checkout migrations repository
        # Requires two repo secrets configured in this repository:
        #  - MIGRATIONS_REPOSITORY: e.g. "<owner>/<private-migrations-repo>"
        #  - MIGRATIONS_PAT: a fine-scoped PAT with repo read access
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.MIGRATIONS_REPOSITORY }}
          token: ${{ secrets.MIGRATIONS_PAT }}
          path: backend/migrations
      - name: Run Flyway migrations
        env:
          FLYWAY_URL: "jdbc:postgresql://127.0.0.1:5432/arch-stats"
          FLYWAY_USER: "admin"
          FLYWAY_PASSWORD: "NOT_A_REAL_PASSWORD"
        run: |
          # Ensure migrations directory exists (checkout above should have created it)
          mkdir -p "${{ github.workspace }}/backend/migrations"
          # Run flyway in a container against the service Postgres on localhost
          docker run --rm \
            --network host \
            -e FLYWAY_URL="$FLYWAY_URL" \
            -e FLYWAY_USER="$FLYWAY_USER" \
            -e FLYWAY_PASSWORD="$FLYWAY_PASSWORD" \
            -e FLYWAY_LOCATIONS=filesystem:/flyway/sql \
            -v "${{ github.workspace }}/backend/migrations:/flyway/sql" \
            flyway/flyway:latest migrate
      - name: Generate OpenAPI Spec
        working-directory: ./backend/src
        env:
          POSTGRES_USER: "admin"
          POSTGRES_PASSWORD: "NOT_A_REAL_PASSWORD"
          POSTGRES_DB: "arch-stats"
          POSTGRES_HOST: "127.0.0.1"
          POSTGRES_PORT: "5432"
          ARCH_STATS_DEV_MODE: "true"
          ARCH_STATS_SERVER_PORT: "8000"
          ARCH_STATS_WS_CHANNEL: "archy"
          GOOGLE_OAUTH_CLIENT_ID: "NOT_A_REAL_CLIENT_ID"
          PYTHONPATH: "${{ github.workspace }}/backend/src"
        run: |
          source "${GITHUB_WORKSPACE}/backend/.venv/bin/activate"
          uv run "${GITHUB_WORKSPACE}/scripts/generate_openapi.py"
      - name: Generate TypeScript types
        working-directory: ./frontend
        run: npx openapi-typescript "${GITHUB_WORKSPACE}/openapi.json" --export-type --immutable --output "${GITHUB_WORKSPACE}/frontend/src/types/types.generated.ts"
      - name: Build FE bundle
        working-directory: ./frontend
        run: npm run build
      - name: Build tar file
        env:
          XZ_OPT: -9
        run: tar -cvJf "${GITHUB_WORKSPACE}/arch-stats.tar.xz" --exclude='backend/tests' --exclude='backend/.venv' --exclude='backend/.mypy_cache' --exclude='*/__pycache__' ./backend
      - name: Upload to release (overwrite)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest Build
          files: ${{ github.workspace}}/arch-stats.tar.xz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
